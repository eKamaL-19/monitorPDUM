<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0" />
    <title>Monitoring Tarik Data Siswa Madrasah</title>
	<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,
		%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E
		%3Cdefs%3E
		%3ClinearGradient id='g' x1='0' y1='0' x2='1' y2='1'%3E
		%3Cstop offset='0%25' stop-color='%234f46e5'/%3E
		%3Cstop offset='100%25' stop-color='%237c3aed'/%3E
		%3C/linearGradient%3E
		%3C/defs%3E
		%3Crect width='64' height='64' rx='14' fill='url(%23g)'/%3E
		%3Cpath d='M32 10a22 22 0 1 0 22 22h-6a16 16 0 1 1-16-16z' fill='white'/%3E
		%3Ccircle cx='32' cy='32' r='4' fill='white'/%3E
		%3Cline x1='32' y1='32' x2='48' y2='48' stroke='white' stroke-width='4' stroke-linecap='round'/%3E
		%3C/svg%3E">
    <meta name="description" content="Dashboard monitoring progres penarikan data siswa madrasah" />

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <!-- DataTables CSS -->
    <link href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" rel="stylesheet" />
    <link href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css" rel="stylesheet" />
    <link href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css" rel="stylesheet" />
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />

    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --bg-body: #f3f4f6;
            --text-primary: #1f2937;
        }

        * {
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* --- Header Section --- */
		.header-section {
			background: var(--primary-gradient);
			color: white;
			padding: 1.5rem 1rem 2rem;
			border-bottom-left-radius: 2rem;
			border-bottom-right-radius: 2rem;
			margin-bottom: -1.5rem;
			position: relative;
			z-index: 1;
			box-shadow: 0 4px 20px rgba(79, 70, 229, 0.3);
			flex-shrink: 0;
		}

		.header-title {
			font-weight: 800;
			font-size: clamp(1.3rem, 3.5vw, 1.6rem);
			letter-spacing: -0.025em;
			line-height: 1.1;
			margin-bottom: 0.3rem;
		}

		.header-subtitle {
			opacity: 0.9;
			font-weight: 500;
			font-size: clamp(0.85rem, 1.8vw, 0.95rem);
			margin-bottom: 0.5rem;
			line-height: 1.2;
		}
		.badge-timestamp {
			background: rgba(255, 255, 255, 0.15) !important;
			border: 1px solid rgba(255, 255, 255, 0.2) !important;
			font-size: 0.8rem !important;
			padding: 0.35rem 0.8rem !important;
			backdrop-filter: blur(10px);
		}
        /* --- Main Content Container --- */
        .main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 2;
            padding: 0 1rem;
            width: 100%;
            max-width: 100%;
            overflow-x: hidden;
        }

        /* --- Cards --- */
        .custom-card {
            background: white;
            border: none;
            border-radius: 1rem;
            box-shadow: var(--card-shadow);
            transition: transform 0.2s, box-shadow 0.2s;
            height: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .custom-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        /* Jenjang Specific Gradients for Icons */
        .bg-icon-ra { background: #fee2e2; color: #ef4444; }
        .bg-icon-mi { background: #e0e7ff; color: #4f46e5; }
        .bg-icon-mts { background: #dcfce7; color: #10b981; }
        .bg-icon-ma { background: #fef3c7; color: #f59e0b; }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            margin-bottom: 1rem;
        }

        .progress-micro {
            height: 8px;
            border-radius: 4px;
            background-color: #f3f4f6;
            margin-top: auto;
            overflow: hidden;
        }
        
        .progress-bar-animated {
            animation: progressLoad 1.5s ease-out forwards;
        }

        @keyframes progressLoad {
            from { width: 0; }
        }

        /* --- Chart Containers --- */
        .chart-container {
            position: relative;
            width: 100%;
            height: 100%;
            min-height: 280px;
            display: flex;
            flex-direction: column;
            padding: 15px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e5e7eb;
        }

        .chart-title {
            font-weight: 600;
            color: #374151;
            font-size: 1rem;
            margin: 0;
        }

        .chart-wrapper {
            position: relative;
            flex: 1;
            width: 100%;
            height: calc(100% - 40px);
            min-height: 200px;
            padding: 5px;
        }

        /* Chart specific sizes for better responsiveness */
		#overallChartContainer,
		#validasiChartContainer {
			height: 320px;
			display: flex;
			flex-direction: column;
		}
		#overallChartContainer .chart-wrapper,
		#validasiChartContainer .chart-wrapper {
			flex: 1;
			height: 220px;
			max-height: 220px;
			padding: 0;
		}
		#overallChartContainer .chart-header,
		#validasiChartContainer .chart-header {
			min-height: 80px;
		}
		#overallChart,
		#validasiChart {
			width: 100% !important;
			height: 100% !important;
		}
        #lembagaChartContainer {
            height: 320px;
            min-height: 320px;
        }

        /* Responsive chart adjustments */
		@media (max-width: 768px) {
			#overallChartContainer,
			#validasiChartContainer,
			#lembagaChartContainer {
				height: 280px;
				min-height: 280px;
			}
		}


		@media (max-width: 576px) {
			#overallChartContainer,
			#validasiChartContainer,
			#lembagaChartContainer {
				height: 250px;
				min-height: 250px;
			}
		}


        /* --- Table Section --- */
        .table-card {
            background: white;
            border-radius: 1.5rem;
            box-shadow: var(--card-shadow);
            padding: 1.5rem;
            margin-top: 2rem;
            border: 1px solid rgba(0,0,0,0.05);
            flex-shrink: 0;
            width: 100%;
            overflow: hidden;
        }

        .filter-box {
            background: #f9fafb;
            border-radius: 1rem;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            border: 1px solid #e5e7eb;
            width: 100%;
        }

        /* Custom Badges */
        .badge-custom {
            padding: 0.5em 0.8em;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.75rem;
            letter-spacing: 0.025em;
            white-space: nowrap;
        }
        .badge-sukses { background-color: #dcfce7; color: #166534; }
        .badge-belum { background-color: #fee2e2; color: #991b1b; }

        /* Status Text Colors */
        .text-status-sukses { color: #198754 !important; font-weight: 700; }
        .text-status-belum { color: #dc3545 !important; font-weight: 700; }

        /* ===================== */
        /* PERBAIKAN TABEL */
        /* ===================== */
        
        /* Header Tabel Rata Tengah */
        table.dataTable thead th {
            background: var(--primary-gradient) !important; 
            background-color: #4f46e5 !important;
            color: white !important;
            font-weight: 700 !important;
            border-bottom: none !important;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.05em;
            padding: 14px 8px !important;
            vertical-align: middle;
            white-space: nowrap;
            text-align: center !important;
        }
        
        /* Rounded corners for first and last header cells */
        table.dataTable thead th:first-child { 
            border-top-left-radius: 10px; 
            border-bottom-left-radius: 10px; 
        }
        table.dataTable thead th:last-child { 
            border-top-right-radius: 10px; 
            border-bottom-right-radius: 10px; 
        }

        /* Isi Tabel Rata Tengah KECUALI Nama Madrasah dan Alamat */
        table.dataTable tbody td {
            padding: 12px 8px;
            border-bottom: 1px solid #f3f4f6;
            vertical-align: middle;
            text-align: center;
        }
        
        /* KOLOM NAMA MADRASAH dan ALAMAT: Rata Kiri */
        table.dataTable tbody td:nth-child(2),
        table.dataTable tbody td:nth-child(3) {
            text-align: left !important;
        }
        
        /* Badge di dalam tabel */
        table.dataTable tbody .badge-custom {
            display: inline-block;
            margin: 0 auto;
        }

        /* Validasi Badge Styling */
        .badge-validasi {
            padding: 0.4em 0.8em;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.75rem;
            letter-spacing: 0.025em;
        }
        .badge-valid { background-color: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
        .badge-invalid { background-color: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .badge-pending { background-color: #fef3c7; color: #92400e; border: 1px solid #fde68a; }

        table.dataTable tbody tr:hover {
            background-color: #f8fafc !important;
        }

        /* DataTables responsive adjustments */
        .dataTables_wrapper {
            width: 100%;
            overflow-x: auto;
        }

        /* Buttons DT */
        .dt-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
        }

        .dt-buttons .btn {
            border-radius: 8px !important;
            font-size: 0.85rem;
            font-weight: 500;
            border: none;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            white-space: nowrap;
        }
        .btn-dt-excel { background-color: #10b981; color: white; min-width: 80px; max-width: 90px;}
        .btn-dt-pdf { background-color: #ef4444; color: white; min-width: 80px; max-width: 90px;}
        .btn-dt-print { background-color: #6366f1; color: white; min-width: 80px; max-width: 90px;}
        
        /* Loading */
        .loading-overlay {
            position: fixed; 
            inset: 0; 
            background: rgba(255,255,255,0.95);
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center;
            z-index: 9999; 
            backdrop-filter: blur(5px);
        }

        /* Footer */
        .footer {
            margin-top: auto;
            padding: 1.5rem 1rem;
            text-align: center;
            color: #6b7280;
            font-size: 0.875rem;
            border-top: 1px solid #e5e7eb;
            background: white;
            flex-shrink: 0;
        }

        /* Grid adjustments for responsive layout */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
            width: 100%;
        }

        /* Responsive adjustments */
        @media (max-width: 1200px) {
            .chart-container {
                min-height: 260px;
            }
        }

        @media (max-width: 992px) {
            .header-section {
                padding: 2rem 1rem 3rem;
                margin-bottom: -2rem;
            }
            
            .table-card {
                padding: 1rem;
                margin-top: 1.5rem;
            }
            
            .filter-box {
                padding: 1rem;
            }
        }

        @media (max-width: 768px) {
            .header-section {
                padding: 1.5rem 1rem 2.5rem;
                margin-bottom: -1.5rem;
                border-bottom-left-radius: 1.5rem;
                border-bottom-right-radius: 1.5rem;
            }
            
            .main-container {
                padding: 0 0.75rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }
            
            .custom-card {
                padding: 1rem !important;
            }
            
            .chart-wrapper {
                padding: 5px;
            }
            
            /* Responsive table adjustments */
            table.dataTable thead th {
                font-size: 0.8rem;
                padding: 10px 6px !important;
            }
            
            table.dataTable tbody td {
                font-size: 0.85rem;
                padding: 10px 6px;
            }
        }
		
		/* Custom Dropdown untuk Length Menu */
		.dataTables_length select {
			border-radius: 8px !important;
			border: 1px solid #e5e7eb !important;
			padding: 0.375rem 2rem 0.375rem 0.75rem !important;
			font-size: 0.875rem !important;
			background-color: white !important;
			box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05) !important;
			transition: border-color 0.2s, box-shadow 0.2s !important;
		}

		.dataTables_length select:focus {
			border-color: #4f46e5 !important;
			box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1) !important;
			outline: none !important;
		}
		/* Styling untuk layout kontrol DataTables */
		.dataTables_wrapper .dataTables_length,
		.dataTables_wrapper .dataTables_filter,
		.dataTables_wrapper .dataTables_buttons {
			margin-bottom: 0.5rem;
		}
		.dataTables_length label {
			font-size: 0.875rem !important;
			color: #6b7280 !important;
			margin-bottom: 0 !important;
		}
		/* CSS Grid Layout untuk DataTables */
		.dt-grid-container {
			display: grid;
			grid-template-columns: 1fr auto 1fr;
			grid-template-areas: "left center right";
			align-items: center;
			gap: 20px;
			margin-bottom: 1rem;
			width: 100%;
		}

		.dt-grid-item-left {
			grid-area: left;
			justify-self: start;
		}

		.dt-grid-item-center {
			grid-area: center;
			justify-self: center;
			min-width: 300px;
			max-width: 400px;
			width: 100%;
		}

		.dt-grid-item-right {
			grid-area: right;
			justify-self: end;
		}

		/* Dropdown length menu */
		.dataTables_length {
			white-space: nowrap;
		}

		/* Filter search */
		.dataTables_filter {
			width: 100%;
		}

		.dataTables_filter label {
			width: 100%;
			display: flex;
			justify-content: center;
		}

		.dataTables_filter input {
			width: 100% !important;
		}

		/* Tombol */
		.dt-buttons {
			display: flex;
			gap: 5px;
			white-space: nowrap;
		}

		/* Responsif dengan CSS Grid */
		@media (max-width: 992px) {
			.dt-grid-container {
				grid-template-columns: 1fr;
				grid-template-areas: 
					"left"
					"right"
					"center";
				gap: 10px;
			}
			
			.dt-grid-item-left,
			.dt-grid-item-center,
			.dt-grid-item-right {
				justify-self: stretch;
				width: 100%;
			}
			
			.dt-grid-item-center {
				order: 3;
			}
			
			.dataTables_filter input {
				max-width: 100%;
			}
			
			.dt-buttons {
				justify-content: flex-start;
				flex-wrap: wrap;
			}
		}
        @media (max-width: 576px) {
            .header-section {
                padding: 1rem 0.75rem 2rem;
                margin-bottom: -1rem;
            }
            
            .header-title {
                font-size: 1.3rem;
            }
            
            .main-container {
                padding: 0 0.5rem;
            }
            
            .table-card {
                padding: 0.75rem;
                border-radius: 1rem;
                margin-top: 1rem;
            }
            
            .filter-box {
                padding: 0.75rem;
            }
            
            .dt-buttons .btn {
                font-size: 0.75rem;
                padding: 0.4rem 0.6rem;
            }
            
            table.dataTable thead th {
                font-size: 0.75rem;
                padding: 8px 4px !important;
            }
            
            table.dataTable tbody td {
                font-size: 0.8rem;
                padding: 8px 4px;
            }
        }

        /* Ensure tables are scrollable on small screens */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* Prevent horizontal scrolling on body */
        body {
            overflow-x: hidden;
        }

        /* Make sure container doesn't cause overflow */
        .container, .container-fluid {
            max-width: 100%;
            padding-right: var(--bs-gutter-x, 0.75rem);
            padding-left: var(--bs-gutter-x, 0.75rem);
            margin-right: auto;
            margin-left: auto;
        }
    </style>
</head>

<body>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
        <h5 class="mt-3 font-weight-bold text-dark">Sedang Mengambil Data...</h5>
        <small class="text-muted">Menghubungkan ke DataBase...</small>
    </div>

    <!-- Header -->
    <div class="header-section text-center">
        <div class="container">
            <h1 class="header-title"><i class="fas fa-satellite-dish me-2"></i>MONITOR TARIK EMIS - PDUM</h1>
            <p class="header-subtitle">KEMENAG KABUPATEN SUMENEP</p>
			<span class="badge bg-white text-primary rounded-pill px-2 px-sm-3 py-1 py-sm-2 mt-1 mt-sm-2 shadow-sm" style="font-size: clamp(0.75rem, 2vw, 0.875rem);">
				<i class="fas fa-clock me-1"></i> 
				<span class="d-none d-sm-inline">Data di Update</span>
				<span class="d-inline d-sm-none">Update</span>
				Tiap Pagi Pukul 06:00 WIB
			</span>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-container container">
        
        <!-- Charts Row -->
        <div class="row g-4 mb-4">

			<!-- Progres Keseluruhan -->
			<div class="col-lg-3 col-md-12">
				<div class="custom-card">
					<div class="chart-container" id="overallChartContainer">
						<div class="chart-header">
							<h6 class="chart-title">
								<i class="fas fa-chart-pie me-2 text-primary"></i>
								Progres Keseluruhan
							</h6>
							<div class="text-center">
								<div class="display-6 fw-bold text-primary mb-0" id="totalPercent">0%</div>
								<small class="text-muted">LEMBAGA SELESAI</small>
							</div>
						</div>
						<div class="chart-wrapper">
							<canvas id="overallChart"></canvas>
						</div>
					</div>
				</div>
			</div>

			<!-- Progres Validasi (BARU) -->
			<div class="col-lg-3 col-md-12">
				<div class="custom-card">
					<div class="chart-container" id="validasiChartContainer">
						<div class="chart-header">
							<h6 class="chart-title">
								<i class="fas fa-check-double me-2 text-primary"></i>
								Progres Validasi
							</h6>
							<div class="text-center">
								<div class="display-6 fw-bold text-primary mb-0" id="validasiPercent">0%</div>
								<small class="text-muted">DATA TERVALIDASI</small>
							</div>
						</div>
						<div class="chart-wrapper">
							<canvas id="validasiChart"></canvas>
						</div>
					</div>
				</div>
			</div>

			<!-- Progres per Jenjang -->
			<div class="col-lg-6 col-md-12">
				<div class="custom-card">
					<div class="chart-container" id="lembagaChartContainer">
						<div class="chart-header">
							<h6 class="chart-title">
								<i class="fas fa-chart-bar me-2 text-primary"></i>
								Progres per Jenjang
							</h6>
							<div class="small text-muted">
								<i class="fas fa-info-circle me-1"></i>
								<span id="totalLembagaText">Total: 0 Lembaga</span>
							</div>
						</div>
						<div class="chart-wrapper">
							<canvas id="lembagaChart"></canvas>
						</div>
					</div>
				</div>
			</div>

		</div>


        <!-- Stats Cards Grid -->
        <div class="row g-3 mb-4" id="statsCards">
            <!-- Cards will be injected here -->
        </div>

        <!-- Table Section -->
        <div class="table-card">
            <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
                <h4 class="fw-bold mb-0"><i class="fas fa-list-alt me-2 text-primary"></i>Detail Data Madrasah</h4>
                <div class="small text-muted" id="tableInfo">
                    Memuat data...
                </div>
            </div>

            <!-- Custom Filters -->
            <div class="filter-box">
                <div class="row g-3 align-items-end">
                    <div class="col-md-3 col-12">
                        <label class="form-label small fw-bold text-uppercase text-muted">Jenjang</label>
                        <select id="filterJenjang" class="form-select border-0 shadow-sm">
                            <option value="">Semua Jenjang</option>
                        </select>
                    </div>

                    <div class="col-md-3 col-12">
                        <label class="form-label small fw-bold text-uppercase text-muted">Status</label>
                        <select id="filterStatus" class="form-select border-0 shadow-sm">
                            <option value="">Semua Status</option>
                            <option value="SUKSES">Sudah Tarik</option>
                            <option value="BELUM">Belum Tarik</option>
                        </select>
                    </div>
                    <div class="col-md-3 col-12">
                        <label class="form-label small fw-bold text-uppercase text-muted">Alamat</label>
                        <select id="filterAlamat" class="form-select border-0 shadow-sm">
                            <option value="">Semua Alamat</option>
                        </select>
                    </div>                    
					<div class="col-md-3 col-12">
                        <button id="resetFilters" class="btn btn-danger w-100 shadow-sm text-white">
                            <i class="fas fa-sync-alt me-2"></i>Reset Filter
                        </button>
                    </div>
                </div>
            </div>

            <div class="table-responsive">
                <table id="madrasahTable" class="table table-hover align-middle w-100">
                    <thead>
                        <tr>
                            <th>NSM</th>
                            <th>Nama Madrasah</th>
                            <th>Alamat</th>
                            <th>Jml Siswa</th>
                            <th>Status</th>
                            <th>Validasi</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer">
        &copy; By: KamaLeka_19 - Dashboard Monitoring PDUM
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- DataTables -->
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>

    <script>
        // ================= CONFIGURATION =================
        const SPREADSHEET_ID = '1zgWxa0CDNx1VDF0Rw1kbJSdjkrVMkzs2dtJDgpBIkPg';
        const SHEET_GID = '0';
        const GVIZ_URL = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?gid=${SHEET_GID}&tqx=out:json`;
        // UPDATE: Mengambil kolom B, C, D, E, F, G (tanpa kolom A/NO)
        const QUERY = `select B,C,D,E,F,G`;

        // Global Vars
        let dataTable = null;
        let overallChart = null;
        let lembagaChart = null;
		let validasiChart = null;
        let allData = [];

        // ================= HELPERS =================
        const cleanStr = (s) => (s || '').toString().trim();
        const safeInt = (s) => {
            const n = parseInt(cleanStr(s).replace(/[^\d]/g, ''), 10);
            return isNaN(n) ? 0 : n;
        };
        const getJenjang = (nsm) => {
            const code = cleanStr(nsm).substring(0, 2);
            const map = { '10': 'RA', '11': 'MI', '12': 'MTS', '13': 'MA' };
            return map[code] || 'LAINNYA';
        };
        const isSukses = (status) => cleanStr(status).toLowerCase().includes('sudah');
        
        // Fungsi untuk menentukan warna badge validasi
        const getValidasiBadge = (validasi) => {
            const val = cleanStr(validasi).toLowerCase();
            if (val.includes('valid') || val.includes('benar') || val.includes('ok')) {
                return '<span class="badge-validasi badge-valid"><i class="fas fa-check-circle me-1"></i>SUDAH VALIDASI</span>';
            } else if (val.includes('tidak') || val.includes('salah') || val.includes('invalid')) {
                return '<span class="badge-validasi badge-invalid"><i class="fas fa-times-circle me-1"></i>TIDAK VALID</span>';
            } else if (val.includes('proses') || val.includes('pending') || val.includes('menunggu')) {
                return '<span class="badge-validasi badge-pending"><i class="fas fa-clock me-1"></i>PROSES</span>';
            } else {
                return '<span class="badge-validasi badge-pending"><i class="fas fa-question-circle me-1"></i>BELUM DIVALIDASI</span>';
            }
        };

        // ================= DATA FETCHING =================
        function fetchData() {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                const cbName = 'gviz_cb_' + Date.now();
                
                window.google = { visualization: { Query: { setResponse: (res) => {
                    delete window.google;
                    document.head.removeChild(script);
                    if(res.status === 'ok') resolve(res.table);
                    else reject(res.errors);
                }}}};

                script.src = `${GVIZ_URL}&tq=${encodeURIComponent(QUERY)}&cb=google.visualization.Query.setResponse`;
                script.onerror = () => reject('Network Error / Blocked');
                document.head.appendChild(script);
            });
        }

        // ================= PROCESS & RENDER =================
        async function initDashboard() {
            try {
                // Fetch data
                const rawTable = await fetchData();
                allData = rawTable.rows.map(r => {
                    const c = r.c;
                    const statusVal = cleanStr(c[4]?.v); // Kolom F (indeks 4)
                    const validasiVal = cleanStr(c[5]?.v); // Kolom G (indeks 5)
                    return {
                        nsm: cleanStr(c[0]?.v),        // Kolom B (NSM)
                        nama: cleanStr(c[1]?.v),       // Kolom C (Nama Madrasah)
                        alamat: cleanStr(c[2]?.v),     // Kolom D (Alamat/Kecamatan)
                        jml: safeInt(c[3]?.v),         // Kolom E (Jumlah Siswa)
                        statusRaw: statusVal,
                        validasi: validasiVal,
                        jenjang: getJenjang(c[0]?.v),  // Ambil dari NSM
                        sukses: isSukses(statusVal)
                    };
                });

                if(allData.length === 0) throw new Error("Data Kosong");

                // Calculate statistics
                const stats = calculateStats(allData);
				const validasiStats = calculateValidasiStats(allData);

                
                // Render all components
                renderCards(stats.perJenjang);
                renderOverallChart(stats.sukses, stats.belum);
				renderValidasiChart(validasiStats.valid, validasiStats.belum);
                renderLembagaChart(stats.perJenjang);
                initTable(allData);
                
                // Update table info
                document.getElementById('tableInfo').textContent = 
                    `Menampilkan ${allData.length} madrasah`;
                document.getElementById('totalLembagaText').textContent = 
                    `Total: ${allData.length} Lembaga`;

                // Hide loading
                document.getElementById('loadingOverlay').style.display = 'none';

            } catch (err) {
                console.error(err);
                document.getElementById('loadingOverlay').innerHTML = `
                    <div class="text-center p-4 bg-white rounded shadow" style="max-width: 500px;">
                        <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                        <h5 class="fw-bold text-dark mb-2">Gagal Memuat Data</h5>
                        <p class="text-muted mb-3">${err.message || err}</p>
                        <button onclick="location.reload()" class="btn btn-primary">
                            <i class="fas fa-redo me-2"></i>Coba Lagi
                        </button>
                    </div>
                `;
            }
        }

        function calculateStats(data) {
            const stats = {
                total: data.length,
                sukses: data.filter(r => r.sukses).length,
                belum: data.filter(r => !r.sukses).length,
                perJenjang: {}
            };
            
            const jenjangList = ['RA', 'MI', 'MTS', 'MA', 'LAINNYA'];
            jenjangList.forEach(j => {
                const subset = data.filter(r => r.jenjang === j);
                stats.perJenjang[j] = {
                    total: subset.length,
                    sukses: subset.filter(r => r.sukses).length,
                    belum: subset.filter(r => !r.sukses).length,
                    name: j
                };
            });
            
            return stats;
        }

        function renderCards(data) {
            const container = document.getElementById('statsCards');
            const config = {
                'RA': { icon: 'fa-shapes', color: 'bg-icon-ra', bar: 'bg-danger' },
                'MI': { icon: 'fa-child-reaching', color: 'bg-icon-mi', bar: 'bg-primary' },
                'MTS': { icon: 'fa-book-open', color: 'bg-icon-mts', bar: 'bg-success' },
                'MA': { icon: 'fa-graduation-cap', color: 'bg-icon-ma', bar: 'bg-warning' },
                'LAINNYA': { icon: 'fa-school', color: 'bg-light', bar: 'bg-secondary' }
            };

            container.innerHTML = '';
            
            Object.keys(data).forEach(key => {
                const s = data[key];
                if (s.total === 0) return;
                
                const pct = s.total > 0 ? Math.round((s.sukses / s.total) * 100) : 0;
                const conf = config[key] || { icon: 'fa-school', color: 'bg-light', bar: 'bg-secondary' };

                const html = `
                <div class="col-md-6 col-lg-3">
                    <div class="custom-card p-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="stat-icon ${conf.color}">
                                    <i class="fas ${conf.icon}"></i>
                                </div>
                                <h5 class="fw-bold mb-1">${key}</h5>
                                <div class="text-muted small">${s.total} Lembaga</div>
                            </div>
                            <div class="text-end">
                                <div class="display-6 fw-bold text-dark">${pct}%</div>
                                <span class="badge ${pct === 100 ? 'bg-success' : 'bg-light text-dark'} rounded-pill border">
                                    ${s.sukses} Selesai
                                </span>
                            </div>
                        </div>
                        <div class="mt-3 small">
                            <div class="d-flex justify-content-between text-muted">
                                <span>Sudah: ${s.sukses}</span>
                                <span>Belum: ${s.belum}</span>
                            </div>
                        </div>
                        <div class="progress progress-micro mt-2">
                            <div class="progress-bar ${conf.bar} progress-bar-animated" 
                                 role="progressbar" 
                                 style="width: ${pct}%"></div>
                        </div>
                    </div>
                </div>`;
                container.insertAdjacentHTML('beforeend', html);
            });
        }

        function renderOverallChart(sukses, belum) {
            const ctx = document.getElementById('overallChart');
            const total = sukses + belum;
            const pct = Math.round((sukses / total) * 100);

            // Update text
            document.getElementById('totalPercent').innerText = pct + '%';

            // Destroy existing chart
            if (overallChart) overallChart.destroy();

            overallChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Sudah Tarik', 'Belum Tarik'],
                    datasets: [{
                        data: [sukses, belum],
                        backgroundColor: ['#10b981', '#ef4444'],
                        borderWidth: 0,
                        hoverOffset: 10,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    layout: {
                        padding: {
                            top: 10,
                            bottom: 20,
                            left: 10,
                            right: 10
                        }
                    },
                    plugins: {
                        legend: { 
                            position: 'bottom',
                            align: 'center',
                            labels: { 
                                usePointStyle: true,
                                padding: 20,
                                font: { 
                                    family: "'Plus Jakarta Sans', sans-serif", 
                                    size: 12 
                                },
                                boxWidth: 10,
                                boxHeight: 10
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const percentage = Math.round((value / total) * 100);
                                    return ` ${context.label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderLembagaChart(data) {
            const ctx = document.getElementById('lembagaChart');
            const jenjangList = ['RA', 'MI', 'MTS', 'MA', 'LAINNYA'];
            
            const labels = jenjangList.filter(j => data[j] && data[j].total > 0);
            const suksesData = labels.map(j => data[j].sukses);
            const belumData = labels.map(j => data[j].belum);
            const totalData = labels.map(j => data[j].total);

            // Destroy existing chart
            if (lembagaChart) lembagaChart.destroy();

            lembagaChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Sudah Tarik',
                            data: suksesData,
                            backgroundColor: '#10b981',
                            borderColor: '#10b981',
                            borderWidth: 1,
                            borderRadius: 4,
                            borderSkipped: false,
                        },
                        {
                            label: 'Belum Tarik',
                            data: belumData,
                            backgroundColor: '#ef4444',
                            borderColor: '#ef4444',
                            borderWidth: 1,
                            borderRadius: 4,
                            borderSkipped: false,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 10,
                            bottom: 20,
                            left: 10,
                            right: 10
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    family: "'Plus Jakarta Sans', sans-serif",
                                    size: 11
                                }
                            },
                            stacked: true
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0,
                                font: {
                                    family: "'Plus Jakarta Sans', sans-serif",
                                    size: 11
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            stacked: true
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            align: 'end',
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                font: {
                                    family: "'Plus Jakarta Sans', sans-serif",
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const dataset = context.dataset;
                                    const value = context.raw;
                                    const label = dataset.label;
                                    const total = totalData[context.dataIndex];
                                    const percentage = Math.round((value / total) * 100);
                                    return ` ${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
		function calculateValidasiStats(data) {
			const total = data.length;
			const valid = data.filter(d => {
				const v = d.validasi.toLowerCase();
				return v.includes('valid') || v.includes('benar') || v.includes('ok');
			}).length;

			const belum = total - valid;

			return { total, valid, belum };
		}
		function renderValidasiChart(valid, belum) {
			const ctx = document.getElementById('validasiChart');
			const total = valid + belum;
			const pct = total > 0 ? Math.round((valid / total) * 100) : 0;

			document.getElementById('validasiPercent').innerText = pct + '%';

			if (validasiChart) validasiChart.destroy();

			validasiChart = new Chart(ctx, {
				type: 'doughnut',
				data: {
					labels: ['Sudah Validasi', 'Belum / Proses'],
					datasets: [{
						data: [valid, belum],
						backgroundColor: ['#3b82f6', '#f59e0b'],
						borderWidth: 0,
						hoverOffset: 10,
						borderRadius: 8
					}]
				},
				options: {
					responsive: true,
					maintainAspectRatio: false,
					cutout: '70%',
							layout: {
								padding: {
									top: 10,
									bottom: 20,
									left: 10,
									right: 10
								}
							},
					plugins: {
						legend: {
							position: 'bottom',
							labels: {
								usePointStyle: true,
								padding: 20,
								font: { size: 12 }
							}
						},
						tooltip: {
							callbacks: {
								label: (ctx) => {
									const v = ctx.raw;
									const p = Math.round((v / total) * 100);
									return ` ${ctx.label}: ${v} (${p}%)`;
								}
							}
						}
					}
				}
			});
		}

        function initTable(data) {
            const tbody = document.querySelector('#madrasahTable tbody');
            
            // Populate Dropdown Jenjang
            const jenjangSet = new Set(data.map(d => d.jenjang));
            const selectJenjang = document.getElementById('filterJenjang');
            jenjangSet.forEach(j => {
                if (j) {
                    selectJenjang.insertAdjacentHTML('beforeend', `<option value="${j}">${j}</option>`);
                }
            });

			// Populate Dropdown Alamat (Diurutkan A-Z)
			const alamatList = Array.from(new Set(data.map(d => d.alamat).filter(a => a)));
			alamatList.sort(); // Urutkan dari A-Z
			const selectAlamat = document.getElementById('filterAlamat');
			alamatList.forEach(a => {
				if (a) {
					selectAlamat.insertAdjacentHTML('beforeend', `<option value="${a}">${a}</option>`);
				}
			});

            // Populate DOM dengan struktur baru
            const rowsHtml = data.map(r => `
                <tr>
                    <td class="fw-bold text-secondary font-monospace">${r.nsm}</td>
                    <td>${r.nama}</td>
                    <td>${r.alamat || '-'}</td>
                    <td class="text-end">${r.jml.toLocaleString('id-ID')}</td>
                    <td>
                        <span class="${r.sukses ? 'text-status-sukses' : 'text-status-belum'}">
                            ${r.statusRaw || '-'}
                        </span>
                    </td>
                    <td>${getValidasiBadge(r.validasi)}</td>
                </tr>
            `).join('');
            tbody.innerHTML = rowsHtml;

            // Initialize DataTables dengan responsive settings
            if (dataTable) {
                dataTable.destroy();
            }

            dataTable = $('#madrasahTable').DataTable({
                responsive: true,
                autoWidth: false,
                pageLength: 10,
                lengthMenu: [[10, 25, 50, -1], ["10", "25", "50", "Semua"]],
				dom: '<"dt-grid-container"<"dt-grid-item-left"l><"dt-grid-item-center"f><"dt-grid-item-right"B>>rt<"dt-grid-bottom"ip>',
				buttons: [
                    { 
                        extend: 'excelHtml5', 
                        className: 'btn btn-dt-excel mb-2 mb-md-0', 
                        text: '<i class="fas fa-file-excel me-1"></i> Excel',
                        title: 'Data_Madrasah_Sumenep'
                    },
                    { 
                        extend: 'pdfHtml5', 
                        className: 'btn btn-dt-pdf mb-2 mb-md-0', 
                        text: '<i class="fas fa-file-pdf me-1"></i> PDF',
                        title: 'Data_Madrasah_Sumenep'
                    },
                    { 
                        extend: 'print', 
                        className: 'btn btn-dt-print mb-2 mb-md-0', 
                        text: '<i class="fas fa-print me-1"></i> Print',
                        title: 'Data Madrasah Sumenep'
                    }
                ],
				language: {
					search: "_INPUT_",
					searchPlaceholder: "Cari NSM / Nama...",
					paginate: { 
						next: '<i class="fas fa-chevron-right"></i>', 
						previous: '<i class="fas fa-chevron-left"></i>' 
					},
					info: "Menampilkan _START_ - _END_ dari _TOTAL_ data",
					lengthMenu: "Tampilkan _MENU_ data"
				},
                columnDefs: [
                    { 
                        targets: [0, 3, 4, 5], // NSM, Jml Siswa, Status, Validasi - rata tengah
                        className: "text-center align-middle"
                    },
                    { 
                        targets: [1, 2], // Nama Madrasah dan Alamat - rata kiri
                        className: "align-middle"
                    },
                    { responsivePriority: 1, targets: 1 }, // Nama Madrasah
                    { responsivePriority: 2, targets: 2 }, // Alamat
                    { responsivePriority: 3, targets: 4 }, // Status
                    { responsivePriority: 4, targets: 5 }, // Validasi
                    { responsivePriority: 5, targets: 0 }, // NSM
                    { responsivePriority: 6, targets: 3 }, // Jml Siswa
                    { className: "text-nowrap", targets: [0, 3, 4, 5] }
                ]
            });

            // Custom Filtering Logic
            $.fn.dataTable.ext.search.push((settings, data, dataIndex) => {
                const fJenjang = $('#filterJenjang').val();
                const fAlamat = $('#filterAlamat').val();
                const fStatus = $('#filterStatus').val();
                
                // Get the row node
                const rowNode = dataTable.row(dataIndex).node();
                if (!rowNode) return true;
                
                // Extract data from row
                const rowNSM = $(rowNode).find('td:first-child').text().trim();
                const rowJenjang = getJenjang(rowNSM);
                const rowAlamat = $(rowNode).find('td:nth-child(3)').text().trim();
                const isSuksesRow = $(rowNode).find('.text-status-sukses').length > 0;
                const statusCheck = isSuksesRow ? 'SUKSES' : 'BELUM';

                if (fJenjang && rowJenjang !== fJenjang) return false;
                if (fAlamat && rowAlamat !== fAlamat) return false;
                if (fStatus && statusCheck !== fStatus) return false;
                return true;
            });

            // Event Listeners
            $('#filterJenjang, #filterAlamat, #filterStatus').on('change', function() {
                dataTable.draw();
                updateTableInfo();
            });

            $('#resetFilters').on('click', function() {
                $('#filterJenjang').val('');
                $('#filterAlamat').val('');
                $('#filterStatus').val('');
                dataTable.search('').draw();
                updateTableInfo();
            });

            // Update table info on page change
            dataTable.on('draw', updateTableInfo);

            function updateTableInfo() {
                const filteredCount = dataTable.rows({ search: 'applied' }).count();
                document.getElementById('tableInfo').textContent = 
                    `Menampilkan ${filteredCount} dari ${allData.length} madrasah`;
            }
        }

        // Handle window resize for charts
        let resizeTimer;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(function() {
                if (overallChart) overallChart.resize();
                if (lembagaChart) lembagaChart.resize();
            }, 250);
        });

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html>
