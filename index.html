<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0" />
    <title>Monitoring Tarik Data Siswa Madrasah</title>
	<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,
		%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E
		%3Cdefs%3E
		%3ClinearGradient id='g' x1='0' y1='0' x2='1' y2='1'%3E
		%3Cstop offset='0%25' stop-color='%234f46e5'/%3E
		%3Cstop offset='100%25' stop-color='%237c3aed'/%3E
		%3C/linearGradient%3E
		%3C/defs%3E
		%3Crect width='64' height='64' rx='14' fill='url(%23g)'/%3E
		%3Cpath d='M32 10a22 22 0 1 0 22 22h-6a16 16 0 1 1-16-16z' fill='white'/%3E
		%3Ccircle cx='32' cy='32' r='4' fill='white'/%3E
		%3Cline x1='32' y1='32' x2='48' y2='48' stroke='white' stroke-width='4' stroke-linecap='round'/%3E
		%3C/svg%3E">
    <meta name="description" content="Dashboard monitoring progres penarikan data siswa madrasah" />

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <!-- DataTables CSS -->
    <link href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" rel="stylesheet" />
    <link href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css" rel="stylesheet" />
    <link href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css" rel="stylesheet" />
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />

    <style>

        :root {
            --primary-gradient: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --bg-body: #f3f4f6;
            --text-primary: #1f2937;
            --color-high: #10b981;
            --color-medium: #f59e0b;
            --color-low: #ef4444;
            --color-complete: #035c41;
        }

        * {
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
		
		/* PROFESSIONAL SPLASH SCREEN    */
		.splash-screen {
			position: fixed;
			inset: 0;
			display: flex;
			align-items: center;
			justify-content: center;
			z-index: 99999;
			transition: opacity 0.6s ease, visibility 0.6s ease;

			background: linear-gradient(
				-45deg,
				#4f46e5,
				#06b6d4,
				#10b981,
				#3b82f6
			);
			background-size: 400% 400%;
			animation: gradientMove 12s ease infinite;
		}

		/* Animasi gradient bergerak */
		@keyframes gradientMove {
			0% {
				background-position: 0% 50%;
			}
			50% {
				background-position: 100% 50%;
			}
			100% {
				background-position: 0% 50%;
			}
		}


		.splash-screen.hidden {
			opacity: 0;
			visibility: hidden;
		}

		.splash-content {
			text-align: center;
			color: white;
			width: 100%;
			max-width: 420px;
			padding: 30px;
			backdrop-filter: blur(12px);
			background: rgba(255, 255, 255, 0.08);
			border-radius: 20px;
			box-shadow: 0 20px 50px rgba(0,0,0,0.25);
		}


		.splash-logo {
			font-size: 50px;
			margin-bottom: 20px;
			animation: pulse 1.5s infinite;
		}

		@keyframes pulse {
			0% { transform: scale(1); opacity: 1; }
			50% { transform: scale(1.08); opacity: 0.85; }
			100% { transform: scale(1); opacity: 1; }
		}

		.splash-title {
			font-size: 1.4rem;
			font-weight: 700;
			margin-bottom: 5px;
		}

		.splash-subtitle {
			font-size: 0.85rem;
			opacity: 0.7;
			margin-bottom: 25px;
		}

		.splash-progress {
			width: 100%;
			height: 6px;
			background: rgba(255,255,255,0.15);
			border-radius: 4px;
			overflow: hidden;
		}


		.splash-progress-bar {
			height: 100%;
			width: 0%;
			background: linear-gradient(
				90deg,
				#ffffff,
				#a5f3fc,
				#ffffff
			);
			background-size: 200% 100%;
			animation: shimmer 2s linear infinite;
			transition: width 0.3s ease;
		}

		@keyframes shimmer {
			0% { background-position: 200% 0; }
			100% { background-position: -200% 0; }
		}

		.splash-loading-text {
			font-size: 0.75rem;
			margin-top: 12px;
			opacity: 0.6;
		}

        /* --- Header Section --- */
		.header-section {
			background: var(--primary-gradient);
			color: white;
			padding: 1.5rem 1rem 2rem;
			border-bottom-left-radius: 2rem;
			border-bottom-right-radius: 2rem;
			margin-bottom: -1.5rem;
			position: relative;
			z-index: 1;
			box-shadow: 0 4px 20px rgba(79, 70, 229, 0.3);
			flex-shrink: 0;
		}

		.header-title {
			font-weight: 800;
			font-size: clamp(1.3rem, 3.5vw, 1.6rem);
			letter-spacing: -0.025em;
			line-height: 1.1;
			margin-bottom: 0.5rem;
		}

		.header-subtitle {
			opacity: 0.95;
			font-weight: 600;
			font-size: clamp(1rem, 2.2vw, 1.15rem);
			line-height: 1.2;
			margin-bottom: 0.5rem;
		}

		.badge-timestamp {
			background: rgba(255, 255, 255, 0.15) !important;
			border: 1px solid rgba(255, 255, 255, 0.2) !important;
			font-size: 0.8rem !important;
			padding: 0.35rem 0.8rem !important;
			backdrop-filter: blur(10px);
		}
        /* --- Main Content Container --- */
        .main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 2;
            padding: 0 1rem;
            width: 100%;
            max-width: 100%;
            overflow-x: hidden;
        }

        /* --- Cards --- */
        .custom-card {
            background: white;
            border: none;
            border-radius: 1rem;
            box-shadow: var(--card-shadow);
            transition: transform 0.2s, box-shadow 0.2s;
            height: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .custom-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        /* Jenjang Specific Gradients for Icons */
        .bg-icon-ra { background: #fee2e2; color: #ef4444; }
        .bg-icon-mi { background: #e0e7ff; color: #4f46e5; }
        .bg-icon-mts { background: #dcfce7; color: #10b981; }
        .bg-icon-ma { background: #fef3c7; color: #f59e0b; }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            margin-bottom: 1rem;
        }

        .progress-micro {
            height: 8px;
            border-radius: 4px;
            background-color: #f3f4f6;
            margin-top: auto;
            overflow: hidden;
        }
        
        .progress-bar-animated {
            animation: progressLoad 1.5s ease-out forwards;
        }

        @keyframes progressLoad {
            from { width: 0; }
        }

        /* --- Chart Containers --- */
        .chart-container {
            position: relative;
            width: 100%;
            height: 100%;
            min-height: 280px;
            display: flex;
            flex-direction: column;
            padding: 15px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e5e7eb;
        }

        .chart-title {
            font-weight: 600;
            color: #374151;
            font-size: 1rem;
            margin: 0;
        }

        .chart-wrapper {
            position: relative;
            flex: 1;
            width: 100%;
            height: calc(100% - 40px);
            min-height: 200px;
            padding: 5px;
        }

        /* Chart specific sizes for better responsiveness */
		#overallChartContainer,
		#validasiChartContainer {
			height: 375px;
			display: flex;
			flex-direction: column;
		}
		#overallChartContainer .chart-wrapper,
		#validasiChartContainer .chart-wrapper {
			flex: 1;
			height: 220px;
			max-height: 220px;
			padding: 0;
		}
		#overallChartContainer .chart-header,
		#validasiChartContainer .chart-header {
			min-height: 80px;
		}
		#overallChart,
		#validasiChart {
			width: 100% !important;
			height: 100% !important;
		}
        #kecamatanTableContainer {
            height: 375px;
            min-height: 375px;
            display: flex;
            flex-direction: column;
        }

        /* Responsive chart adjustments */
		@media (max-width: 768px) {
			#overallChartContainer,
			#validasiChartContainer,
			#kecamatanTableContainer {
				height: 275px;
				min-height: 275px;
			}
		}

		@media (max-width: 576px) {
			#overallChartContainer,
			#validasiChartContainer,
			#kecamatanTableContainer {
				height: 285px;
				min-height: 285px;
			}
		}

		/* --- Kecamatan Table Section --- */
		.kecamatan-table-container {
			flex: 1;
			overflow: auto;
			padding: 8px 4px; /* Padding lebih kecil */
			height: calc(100% - 50px); /* Sesuaikan tinggi */
			display: flex;
			flex-direction: column;
		}

		/* Ensure last item is fully visible on mobile */
		.kecamatan-table-container::after {
			content: '';
			display: block;
			height: 1px;
			visibility: hidden;
		}

		/* GRID BARU: 2 KOLOM */
		.kecamatan-grid {
			display: grid;
			grid-template-columns: repeat(3, 1fr); /* 3 kolom untuk PC */
			gap: 8px; /* Gap lebih kecil */
			width: 100%;
			height: fit-content;
			margin-bottom: 15px;
		}

		.kecamatan-item {
			background: white;
			border-radius: 10px; /* Radius lebih kecil */
			padding: 10px; /* Padding lebih kecil */
			box-shadow: 0 2px 6px rgba(0, 0, 0, 0.07); /* Shadow lebih halus */
			transition: all 0.2s ease;
			border: 1px solid transparent;
			display: flex;
			flex-direction: column;
			min-height: 90px; /* Lebih compact */
			position: relative;
			overflow: hidden;
		}

		/* Background color classes for kecamatan-item */
		.kecamatan-item.bg-high {
			background: linear-gradient(135deg, rgba(16, 185, 129, 0.08), rgba(5, 150, 105, 0.05));
			border-color: rgba(16, 185, 129, 0.2);
		}

		.kecamatan-item.bg-medium {
			background: linear-gradient(135deg, rgba(245, 158, 11, 0.08), rgba(217, 119, 6, 0.05));
			border-color: rgba(245, 158, 11, 0.2);
		}

		.kecamatan-item.bg-low {
			background: linear-gradient(135deg, rgba(239, 68, 68, 0.08), rgba(220, 38, 38, 0.05));
			border-color: rgba(239, 68, 68, 0.2);
		}

		.kecamatan-item.bg-complete {
			background: linear-gradient(135deg, rgba(16, 185, 129, 0.12), rgba(5, 150, 105, 0.08));
			border-color: rgba(5, 150, 105, 0.3);
		}

		.kecamatan-item:hover {
			transform: translateY(-3px);
			box-shadow: 0 8px 16px rgba(0, 0, 0, 0.12);
			border-color: #e5e7eb;
		}

		/* Layout 2 Kolom di dalam Item */
		.kecamatan-row {
			display: flex;
			justify-content: space-between;
			align-items: flex-start;
			width: 100%;
			margin-bottom: 6px;
		}

		/* Kolom Kiri: Nama + Angka */
		.kecamatan-left {
			flex: 1;
			min-width: 0; /* Untuk text overflow */
			padding-right: 5px;
		}

		.kecamatan-name {
			font-weight: 700;
			font-size: 0.85rem;
			line-height: 1.2;
			margin-bottom: 3px;
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
			/* Warna nama akan diatur oleh JavaScript */
		}

		.kecamatan-count {
			font-size: 0.8rem;
			color: #6b7280;
			font-weight: 500;
			white-space: nowrap;
		}

		/* Kolom Kanan: Persentase */
		.kecamatan-right {
			display: flex;
			flex-direction: column;
			align-items: flex-end;
			margin-left: 5px;
		}

		.kecamatan-percent {
			font-weight: 700;
			font-size: 0.9rem;
			padding: 3px 8px;
			border-radius: 15px;
			min-width: 50px;
			text-align: center;
			color: white;
			box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);
			margin-bottom: 4px;
		}

		/* Background color based on percentage */
		.percent-high {
			background: linear-gradient(135deg, var(--color-high), #035c41);
		}

		.percent-medium {
			background: linear-gradient(135deg, var(--color-medium), #d97706);
		}

		.percent-low {
			background: linear-gradient(135deg, var(--color-low), #dc2626);
		}

		.percent-complete {
			background: linear-gradient(135deg, var(--color-high), var(--color-complete));
		}

		/* Progress bar FULL LEBAR di bawah */
		.kecamatan-progress-container {
			margin-top: 4px;
			height: 5px;
			background: rgba(0, 0, 0, 0.08);
			border-radius: 2.5px;
			overflow: hidden;
			width: 100%;
		}

		.kecamatan-progress-bar {
			height: 100%;
			border-radius: 3px;
			transition: width 1s ease-in-out;
		}

		/* Responsive kecamatan grid */
		@media (max-width: 1200px) {
			.kecamatan-grid {
				grid-template-columns: repeat(2, 1fr);
			}
		}

		/* Responsive kecamatan grid untuk tablet */
		@media (max-width: 1024px) {
			.kecamatan-grid {
				grid-template-columns: repeat(2, 1fr); /* 2 kolom untuk tablet */
				gap: 7px;
			}
			
			.kecamatan-item {
				padding: 9px;
				min-height: 88px;
			}
			
			.kecamatan-name {
				font-size: 0.83rem;
			}
			
			.kecamatan-percent {
				font-size: 0.85rem;
				min-width: 48px;
				padding: 2px 7px;
			}
		}

		@media (max-width: 768px) {
			.kecamatan-grid {
				grid-template-columns: repeat(2, 1fr);
				gap: 6px;
			}
			
			.kecamatan-item {
				padding: 8px;
				min-height: 85px;
			}
			
			.kecamatan-name {
				font-size: 0.8rem;
				white-space: normal; /* Allow wrapping */
				line-height: 1.1;
				max-height: 2.2em; /* Maksimal 2 baris */
				overflow: hidden;
				text-overflow: ellipsis;
				display: -webkit-box;
				-webkit-line-clamp: 2; /* Limit to 2 lines */
				-webkit-box-orient: vertical;
			}
			
			.kecamatan-percent {
				font-size: 0.8rem;
				min-width: 45px;
				padding: 2px 6px;
				margin-bottom: 3px;
			}
			
			.kecamatan-count {
				font-size: 0.75rem;
			}
			
			.kecamatan-progress-container {
				height: 4px;
				margin-top: 3px;
			}
		}

		@media (max-width: 576px) {
			.kecamatan-grid {
				grid-template-columns: 1fr; /* 1 kolom untuk HP kecil */
				gap: 6px;
			}
			
			.kecamatan-item {
				padding: 10px;
				min-height: 85px;
			}
			
			.kecamatan-name {
				font-size: 0.85rem;
				-webkit-line-clamp: 1; /* Hanya 1 baris untuk HP kecil */
				max-height: 1.3em;
			}
			
			.kecamatan-percent {
				font-size: 0.85rem;
				min-width: 50px;
			}
			
			.kecamatan-count {
				font-size: 0.8rem;
			}
		}
		/* Untuk HP dengan lebar sangat kecil (di bawah 400px) */
		@media (max-width: 400px) {
			.kecamatan-item {
				padding: 8px;
				min-height: 80px;
			}
			
			.kecamatan-name {
				font-size: 0.78rem;
			}
			
			.kecamatan-percent {
				font-size: 0.78rem;
				min-width: 42px;
				padding: 2px 5px;
			}
			
			.kecamatan-count {
				font-size: 0.72rem;
			}
		}
        /* --- Table Section --- */
        .table-card {
            background: white;
            border-radius: 1.5rem;
            box-shadow: var(--card-shadow);
            padding: 1.5rem;
            margin-top: 2rem;
            border: 1px solid rgba(0,0,0,0.05);
            flex-shrink: 0;
            width: 100%;
            overflow: hidden;
        }

        .filter-box {
            background: #f9fafb;
            border-radius: 1rem;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            border: 1px solid #e5e7eb;
            width: 100%;
        }

        /* Custom Badges */
        .badge-custom {
            padding: 0.5em 0.8em;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.75rem;
            letter-spacing: 0.025em;
            white-space: nowrap;
        }
        .badge-sukses { background-color: #dcfce7; color: #166534; }
        .badge-belum { background-color: #fee2e2; color: #991b1b; }

        /* Status Text Colors */
        .text-status-sukses { color: #198754 !important; font-weight: 700; }
        .text-status-belum { color: #dc3545 !important; font-weight: 700; }

        /* Header Tabel Rata Tengah */
        table.dataTable thead th {
            background: var(--primary-gradient) !important; 
            background-color: #4f46e5 !important;
            color: white !important;
            font-weight: 700 !important;
            border-bottom: none !important;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.05em;
            padding: 14px 8px !important;
            vertical-align: middle;
            white-space: nowrap;
            text-align: center !important;
        }
        
        /* Rounded corners for first and last header cells */
        table.dataTable thead th:first-child { 
            border-top-left-radius: 10px; 
            border-bottom-left-radius: 10px; 
        }
        table.dataTable thead th:last-child { 
            border-top-right-radius: 10px; 
            border-bottom-right-radius: 10px; 
        }

        /* Isi Tabel Rata Tengah KECUALI Nama Madrasah dan Alamat */
        table.dataTable tbody td {
            padding: 12px 8px;
            border-bottom: 1px solid #f3f4f6;
            vertical-align: middle;
            text-align: center;
        }
        
        /* KOLOM NAMA MADRASAH dan ALAMAT: Rata Kiri */
        table.dataTable tbody td:nth-child(2),
        table.dataTable tbody td:nth-child(3) {
            text-align: left !important;
        }
        
        /* Badge di dalam tabel */
        table.dataTable tbody .badge-custom {
            display: inline-block;
            margin: 0 auto;
        }

        /* Validasi Badge Styling */
        .badge-validasi {
            padding: 0.4em 0.8em;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.75rem;
            letter-spacing: 0.025em;
        }
        .badge-valid { background-color: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
        .badge-invalid { background-color: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .badge-pending { background-color: #fef3c7; color: #92400e; border: 1px solid #fde68a; }

        table.dataTable tbody tr:hover {
            background-color: #f8fafc !important;
        }

        /* DataTables responsive adjustments */
        .dataTables_wrapper {
            width: 100%;
            overflow-x: auto;
        }

        /* Buttons DT */
        .dt-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
        }

        .dt-buttons .btn {
            border-radius: 8px !important;
            font-size: 0.85rem;
            font-weight: 500;
            border: none;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            white-space: nowrap;
        }
        .btn-dt-excel { background-color: #10b981; color: white; min-width: 80px; max-width: 90px;}
        .btn-dt-pdf { background-color: #ef4444; color: white; min-width: 80px; max-width: 90px;}
        .btn-dt-print { background-color: #6366f1; color: white; min-width: 80px; max-width: 90px;}
        
        /* Loading */
        .loading-overlay {
            position: fixed; 
            inset: 0; 
            background: rgba(255,255,255,0.95);
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center;
            z-index: 9999; 
            backdrop-filter: blur(5px);
        }

        /* Footer */
        .footer {
            margin-top: auto;
            padding: 1.5rem 1rem;
            text-align: center;
            color: #6b7280;
            font-size: 0.875rem;
            border-top: 1px solid #e5e7eb;
            background: white;
            flex-shrink: 0;
        }

        /* Grid adjustments for responsive layout */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
            width: 100%;
        }

        /* Responsive adjustments */
        @media (max-width: 1200px) {
            .chart-container {
                min-height: 260px;
            }
        }

        @media (max-width: 992px) {
            .header-section {
                padding: 2rem 1rem 3rem;
                margin-bottom: -2rem;
            }
            
            .table-card {
                padding: 1rem;
                margin-top: 1.5rem;
            }
            
            .filter-box {
                padding: 1rem;
            }
        }

        @media (max-width: 768px) {
            .header-section {
                padding: 1.5rem 1rem 2.5rem;
                margin-bottom: -1.5rem;
                border-bottom-left-radius: 1.5rem;
                border-bottom-right-radius: 1.5rem;
            }
            
            .main-container {
                padding: 0 0.75rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }
            
            .custom-card {
                padding: 1rem !important;
            }
            
            .chart-wrapper {
                padding: 5px;
            }
            
            /* Responsive table adjustments */
            table.dataTable thead th {
                font-size: 0.8rem;
                padding: 10px 6px !important;
            }
            
            table.dataTable tbody td {
                font-size: 0.85rem;
                padding: 10px 6px;
            }
        }
		
		/* Custom Dropdown untuk Length Menu */
		.dataTables_length select {
			border-radius: 8px !important;
			border: 1px solid #e5e7eb !important;
			padding: 0.375rem 2rem 0.375rem 0.75rem !important;
			font-size: 0.875rem !important;
			background-color: white !important;
			box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05) !important;
			transition: border-color 0.2s, box-shadow 0.2s !important;
		}

		.dataTables_length select:focus {
			border-color: #4f46e5 !important;
			box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1) !important;
			outline: none !important;
		}
		/* Styling untuk layout kontrol DataTables */
		.dataTables_wrapper .dataTables_length,
		.dataTables_wrapper .dataTables_filter,
		.dataTables_wrapper .dataTables_buttons {
			margin-bottom: 0.5rem;
		}
		.dataTables_length label {
			font-size: 0.875rem !important;
			color: #6b7280 !important;
			margin-bottom: 0 !important;
		}
		/* CSS Grid Layout untuk DataTables */
		.dt-grid-container {
			display: grid;
			grid-template-columns: 1fr auto 1fr;
			grid-template-areas: "left center right";
			align-items: center;
			gap: 20px;
			margin-bottom: 1rem;
			width: 100%;
		}

		.dt-grid-item-left {
			grid-area: left;
			justify-self: start;
		}

		.dt-grid-item-center {
			grid-area: center;
			justify-self: center;
			min-width: 300px;
			max-width: 400px;
			width: 100%;
		}

		.dt-grid-item-right {
			grid-area: right;
			justify-self: end;
		}

		/* Dropdown length menu */
		.dataTables_length {
			white-space: nowrap;
		}

		/* Filter search */
		.dataTables_filter {
			width: 100%;
		}

		.dataTables_filter label {
			width: 100%;
			display: flex;
			justify-content: center;
		}

		.dataTables_filter input {
			width: 100% !important;
		}

		/* Tombol */
		.dt-buttons {
			display: flex;
			gap: 5px;
			white-space: nowrap;
		}

		/* Responsif dengan CSS Grid */
		@media (max-width: 992px) {
			.dt-grid-container {
				grid-template-columns: 1fr;
				grid-template-areas: 
					"left"
					"right"
					"center";
				gap: 10px;
			}
			
			.dt-grid-item-left,
			.dt-grid-item-center,
			.dt-grid-item-right {
				justify-self: stretch;
				width: 100%;
			}
			
			.dt-grid-item-center {
				order: 3;
			}
			
			.dataTables_filter input {
				max-width: 100%;
			}
			
			.dt-buttons {
				justify-content: flex-start;
				flex-wrap: wrap;
			}
		}
        @media (max-width: 576px) {
            .header-section {
                padding: 1rem 0.75rem 2rem;
                margin-bottom: -1rem;
            }
            
            .header-title {
                font-size: 1.3rem;
            }
            
            .main-container {
                padding: 0 0.5rem;
            }
            
            .table-card {
                padding: 0.75rem;
                border-radius: 1rem;
                margin-top: 1rem;
            }
            
            .filter-box {
                padding: 0.75rem;
            }
            
            .dt-buttons .btn {
                font-size: 0.75rem;
                padding: 0.4rem 0.6rem;
            }
            
            table.dataTable thead th {
                font-size: 0.75rem;
                padding: 8px 4px !important;
            }
            
            table.dataTable tbody td {
                font-size: 0.8rem;
                padding: 8px 4px;
            }
        }

        /* Ensure tables are scrollable on small screens */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* Prevent horizontal scrolling on body */
        body {
            overflow-x: hidden;
        }

        /* Make sure container doesn't cause overflow */
        .container, .container-fluid {
            max-width: 100%;
            padding-right: var(--bs-gutter-x, 0.75rem);
            padding-left: var(--bs-gutter-x, 0.75rem);
            margin-right: auto;
            margin-left: auto;
        }

		/* ========================= */
		/* SAAS FILTER STYLE */
		/* ========================= */

		.saas-filter {
			background: linear-gradient(135deg, #ffffff, #f8f9ff);
			border-radius: 20px;
			border: 1px solid rgba(79,70,229,0.08);
			box-shadow: 
				0 20px 40px rgba(79,70,229,0.06),
				inset 0 1px 0 rgba(255,255,255,0.6);
		}


		.saas-filter-row {
			display: flex;
			gap: 16px;
			align-items: center;
		}

		.saas-item {
			flex: 1;
		}

		/* GRADIENT FILTER BOX */
		.saas-select {
			width: 100%;
			height: 46px;
			padding: 0 14px;
			border-radius: 14px;
			border: 1px solid transparent;
			font-weight: 500;
			font-size: 0.9rem;
			transition: all 0.25s ease;
			box-shadow: 0 6px 18px rgba(0,0,0,0.05);
			color: #1f2937;
		}

		/* JENJANG - INDIGO */
		.gradient-jenjang {
			background: linear-gradient(135deg, #ffffff, #eef2ff);
			border-color: rgba(79,70,229,0.25);
		}

		.gradient-jenjang:hover {
			background: linear-gradient(135deg, #ffffff, #e0e7ff);
			box-shadow: 0 8px 22px rgba(79,70,229,0.15);
		}

		.gradient-jenjang:focus {
			border-color: #4f46e5;
			box-shadow: 0 0 0 4px rgba(79,70,229,0.18);
		}

		/* STATUS - EMERALD */

		.gradient-status {
			background: linear-gradient(135deg, #ffffff, #ecfdf5);
			border-color: rgba(16,185,129,0.25);
		}

		.gradient-status:hover {
			background: linear-gradient(135deg, #ffffff, #d1fae5);
			box-shadow: 0 8px 22px rgba(16,185,129,0.15);
		}

		.gradient-status:focus {
			border-color: #10b981;
			box-shadow: 0 0 0 4px rgba(16,185,129,0.18);
		}

		/* ALAMAT - BLUE */
		.gradient-alamat {
			background: linear-gradient(135deg, #ffffff, #eff6ff);
			border-color: rgba(59,130,246,0.25);
		}

		.gradient-alamat:hover {
			background: linear-gradient(135deg, #ffffff, #dbeafe);
			box-shadow: 0 8px 22px rgba(59,130,246,0.15);
		}

		.gradient-alamat:focus {
			border-color: #3b82f6;
			box-shadow: 0 0 0 4px rgba(59,130,246,0.18);
		}

		/* VALIDASI - AMBER */
		.gradient-validasi {
			background: linear-gradient(135deg, #ffffff, #fffbeb);
			border-color: rgba(245,158,11,0.25);
		}

		.gradient-validasi:hover {
			background: linear-gradient(135deg, #ffffff, #fef3c7);
			box-shadow: 0 8px 22px rgba(245,158,11,0.15);
		}

		.gradient-validasi:focus {
			border-color: #f59e0b;
			box-shadow: 0 0 0 4px rgba(245,158,11,0.18);
		}

		/* RESET BUTTON - RED SAAS */
		.saas-reset-danger {
			height: 44px;
			padding: 0 18px;
			border-radius: 12px;
			border: 1px solid #fecaca;
			background: #fee2e2;
			color: #dc2626;
			font-weight: 600;
			font-size: 0.9rem;
			transition: all 0.2s ease;
			display: flex;
			align-items: center;
			justify-content: center;
			gap: 6px;
		}

		.saas-reset-danger:hover {
			background: #dc2626;
			color: white;
			border-color: #dc2626;
			box-shadow: 0 8px 18px rgba(220,38,38,0.25);
			transform: translateY(-2px);
		}

		.saas-reset-danger:active {
			transform: translateY(0);
			box-shadow: 0 4px 10px rgba(220,38,38,0.2);
		}


		/* Responsive */
		@media (max-width: 1100px) {
			.saas-filter-row {
				flex-wrap: wrap;
			}

			.saas-item {
				flex: 1 1 calc(50% - 8px);
			}

			.saas-action {
				flex: 1 1 100%;
			}

			.saas-reset-danger  {
				width: 100%;
			}
		}
		
		/* FILTER RESPONSIVE MOBILE     */

		.filter-row {
			display: grid;
			grid-template-columns: repeat(5, 1fr);
			gap: 10px;
			align-items: end;
		}

		.filter-row .form-select,
		.filter-row .form-control,
		.filter-row .btn {
			width: 100%;
			height: 44px;
			font-size: 0.9rem;
		}

		/* TABLET */
		@media (max-width: 992px) {
			.filter-row {
				grid-template-columns: repeat(2, 1fr);
			}

			#resetFilters {
				grid-column: span 2;
			}
		}

		/* HP */
		@media (max-width: 576px) {
			.filter-row {
				grid-template-columns: 1fr;
			}

			.filter-box {
				padding: 0.9rem;
			}

			.filter-row label {
				font-size: 0.8rem;
				margin-bottom: 3px;
			}

			#resetFilters {
				width: 100%;
				height: 46px;
				font-weight: 600;
			}
		}

    </style>
</head>

<body>

	<!-- SPLASH SCREEN -->
	<div id="splashScreen" class="splash-screen">
		<div class="splash-content">

			<div class="splash-logo">
				<i class="fas fa-satellite-dish"></i>
			</div>

			<h1 class="splash-title">MONITOR EMIS PDUM</h1>
			<p class="splash-subtitle">KEMENAG KABUPATEN SUMENEP</p>

			<div class="splash-progress">
				<div class="splash-progress-bar" id="splashBar"></div>
			</div>

			<small class="splash-loading-text">
				Menghubungkan ke sistem...
			</small>

		</div>
	</div>

	
	<!-- MODAL PESAN CUT OFF -->
	<div class="modal fade" id="cutoffModal" tabindex="-1" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content border-0 shadow-lg">
			  <div class="modal-header bg-danger text-white">
				<h5 class="modal-title fw-bold">
				  ⛔ INFORMASI CUT OFF ⛔
				</h5>
				<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
			  </div>

			  <div class="modal-body text-center">
				<div class="fw-bold text-danger fs-5 mb-2">
				  CUT OFF 31 JANUARI 2026
				</div>

				<div class="fw-bold text-muted mb-1">
				  Sisa Waktu:
				</div>

				<div id="countdownCutoff" class="fw-bold fs-4 text-dark">
				  Menghitung...
				</div>
				<hr>
				<div class="text-center text-muted mt-2">
				  Pastikan seluruh data telah ditarik dan divalidasi sebelum batas waktu cut off.
				</div>
			  </div>
				<!-- Progress Auto Close -->
				<div class="mt-3">
				  <div class="progress" style="height: 6px;">
					<div
					  id="cutoffProgress"
					  class="progress-bar bg-danger progress-bar-striped progress-bar-animated"
					  role="progressbar"
					  style="width: 100%">
					</div>
				  </div>
				</div>

				<div class="modal-footer justify-content-center">
				<button class="btn btn-primary px-4" data-bs-dismiss="modal">
				  Saya Mengerti
				</button>
			  </div>
			</div>
		</div>
	</div>

	<!-- Header -->
	<div class="header-section text-center">
		<div class="container">
			<h1 class="header-title">
				<i class="fas fa-satellite-dish me-2"></i>
				MONITOR TARIK EMIS - PDUM
			</h1>

			<p class="header-subtitle">
				KEMENAG KABUPATEN SUMENEP
			</p>

			<!-- Info Update -->
			<span class="badge bg-white text-primary rounded-pill px-2 px-sm-3 py-1 py-sm-2 mt-1 shadow-sm"
				  style="font-size: clamp(0.75rem, 2vw, 0.875rem);">
				<i class="fas fa-clock me-1"></i>
				<span class="d-none d-sm-inline">Data di Update</span>
				<span class="d-inline d-sm-none">Update</span>
				Tiap Pagi Pukul 06:00 WIB
			</span>
		</div>
	</div>


    <!-- Main Content -->
    <div class="main-container container">
        
        <!-- Charts Row -->
        <div class="row g-4 mb-4">

			<!-- Progres Keseluruhan -->
			<div class="col-lg-3 col-md-12">
				<div class="custom-card">
					<div class="chart-container" id="overallChartContainer">
						<div class="chart-header">
							<h6 class="chart-title">
								<i class="fas fa-chart-pie me-2 text-primary"></i>
								Progres Keseluruhan
							</h6>
							<div class="text-center">
								<div class="display-6 fw-bold text-primary mb-0" id="totalPercent">0%</div>
								<small class="text-muted">LEMBAGA SELESAI</small>
							</div>
						</div>
						<div class="chart-wrapper">
							<canvas id="overallChart"></canvas>
						</div>
					</div>
				</div>
			</div>

			<!-- Progres Validasi -->
			<div class="col-lg-3 col-md-12">
				<div class="custom-card">
					<div class="chart-container" id="validasiChartContainer">
						<div class="chart-header">
							<h6 class="chart-title">
								<i class="fas fa-check-double me-2 text-primary"></i>
								Progres Validasi
							</h6>
							<div class="text-center">
								<div class="display-6 fw-bold text-primary mb-0" id="validasiPercent">0%</div>
								<small class="text-muted">DATA TERVALIDASI</small>
							</div>
						</div>
						<div class="chart-wrapper">
							<canvas id="validasiChart"></canvas>
						</div>
					</div>
				</div>
			</div>

			<!-- Progres per Kecamatan (Diubah dari Jenjang) -->
			<div class="col-lg-6 col-md-12">
				<div class="custom-card">
					<div class="chart-container" id="kecamatanTableContainer">
						<div class="chart-header">
							<h6 class="chart-title">
								<i class="fas fa-map-marker-alt me-2 text-primary"></i>
								Progres per Kecamatan
								<span id="completeBadge" class="badge bg-success ms-2 d-none">0</span>
							</h6>
							<div class="small text-muted">
								<i class="fas fa-info-circle me-1"></i>
								<span id="totalKecamatanText">Total: 0 Kecamatan</span>
							</div>
						</div>
						<div class="kecamatan-table-container" id="kecamatanTableContent">
							<!-- Data kecamatan akan diisi oleh JavaScript -->
							<div class="kecamatan-grid" id="kecamatanGrid">
								<!-- Items akan ditambahkan di sini -->
							</div>
						</div>
					</div>
				</div>
			</div>

		</div>


        <!-- Stats Cards Grid -->
        <div class="row g-3 mb-4" id="statsCards">
            <!-- Cards will be injected here -->
        </div>

        <!-- Table Section -->
        <div class="table-card">
            <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
                <h4 class="fw-bold mb-0"><i class="fas fa-list-alt me-2 text-primary"></i>Detail Data Madrasah</h4>
                <div class="small text-muted" id="tableInfo">
                    Memuat data...
                </div>
            </div>

            <!-- Custom Filters -->
			<div class="filter-box saas-filter">
				<div class="saas-filter-row">

					<div class="saas-item">
						<select id="filterJenjang" class="saas-select gradient-jenjang">
							<option value="">Jenjang</option>
						</select>
					</div>

					<div class="saas-item">
						<select id="filterStatus" class="saas-select gradient-status">
							<option value="">Status</option>
							<option value="SUKSES">Sudah Tarik</option>
							<option value="BELUM">Belum Tarik</option>
						</select>
					</div>

					<div class="saas-item">
						<select id="filterAlamat" class="saas-select gradient-alamat">
							<option value="">Alamat</option>
						</select>
					</div>

					<div class="saas-item">
						<select id="filterValidasi" class="saas-select gradient-validasi">
							<option value="">Validasi</option>
							<option value="SUDAH VALIDASI">Sudah Validasi</option>
							<option value="BELUM VALIDASI">Belum Validasi</option>
							<option value="PROSES">Proses</option>
							<option value="TIDAK VALID">Tidak Valid</option>
						</select>
					</div>

					<div class="saas-action">
						<button id="resetFilters" class="saas-reset-danger">
							<i class="fas fa-rotate"></i>
							<span>Reset Filter</span>
						</button>
					</div>
				</div>
			</div>


            <div class="table-responsive">
                <table id="madrasahTable" class="table table-hover align-middle w-100">
                    <thead>
                        <tr>
                            <th>NSM</th>
                            <th>Nama Madrasah</th>
                            <th>Alamat</th>
                            <th>Jml Siswa</th>
                            <th>Status</th>
                            <th>Validasi</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer">
        &copy; By:Jalangkung Team's- Dashboard Monitoring EMIS PDUM
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- DataTables -->
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>

    <script>
		// ================= PESAN CUT OFF =================
		const SHOW_CUTOFF_MODAL = false; // ubah jadi true kalau mau aktif
		if (SHOW_CUTOFF_MODAL) {
			document.addEventListener("DOMContentLoaded", function () {
				const modalEl = document.getElementById('cutoffModal');
				const modal = new bootstrap.Modal(modalEl);
				const progressBar = document.getElementById('cutoffProgress');

				const duration = 5000;
				const intervalTime = 50;
				let elapsed = 0;

				modal.show();

				const interval = setInterval(() => {
					elapsed += intervalTime;
					const percent = Math.max(0, 100 - (elapsed / duration) * 100);
					progressBar.style.width = percent + '%';

					if (elapsed >= duration) {
						clearInterval(interval);
						modal.hide();
					}
				}, intervalTime);

				modalEl.addEventListener('hidden.bs.modal', () => {
					clearInterval(interval);
				});
			});
		}

		(function () {
			const targetDate = new Date("2026-01-31T23:59:59").getTime();
			const el = document.getElementById("countdownCutoff");

			function updateCountdown() {
				const now = new Date().getTime();
				const diff = targetDate - now;

				if (diff <= 0) {
					el.innerHTML = "<span class='text-danger'>WAKTU HABIS</span>";
					return;
				}

				const days = Math.floor(diff / (1000 * 60 * 60 * 24));
				const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
				const minutes = Math.floor((diff / (1000 * 60)) % 60);
				const seconds = Math.floor((diff / 1000) % 60);

				el.textContent =
					`${days} Hari ${hours} Jam ${minutes} Menit ${seconds} Detik`;
			}

			updateCountdown();
			setInterval(updateCountdown, 1000);
		})();
		
		
        // ================= CONFIGURATION =================
        const SPREADSHEET_ID = '1zgWxa0CDNx1VDF0Rw1kbJSdjkrVMkzs2dtJDgpBIkPg';
        const SHEET_GID = '0';
        const GVIZ_URL = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?gid=${SHEET_GID}&tqx=out:json`;
        // UPDATE: Mengambil kolom B, C, D, E, F, G (tanpa kolom A/NO)
        const QUERY = `select B,C,D,E,F,G`;

        // Global Vars
        let dataTable = null;
        let overallChart = null;
		let validasiChart = null;
        let allData = [];

        // ================= HELPERS =================
        const cleanStr = (s) => (s || '').toString().trim();
        const safeInt = (s) => {
            const n = parseInt(cleanStr(s).replace(/[^\d]/g, ''), 10);
            return isNaN(n) ? 0 : n;
        };
        const getJenjang = (nsm) => {
            const code = cleanStr(nsm).substring(0, 2);
            const map = { '10': 'RA', '11': 'MI', '12': 'MTS', '13': 'MA' };
            return map[code] || 'LAINNYA';
        };
        const isSukses = (status) => cleanStr(status).toLowerCase().includes('sudah');

		// ================= VALIDASI ENGINE =================
		const VALIDASI_STATUS = [
			{
				keywords: ['sudah divalidasi kabko'],
				label: 'SUDAH VALIDASI',
				badgeClass: 'badge-valid',
				icon: 'fa-check-circle'
			},
			{
				keywords: ['belum validasi'],
				label: 'BELUM VALIDASI',
				badgeClass: 'badge-invalid',
				icon: 'fa-times-circle'
			},
			{
				keywords: ['proses pengajuan'],
				label: 'PROSES',
				badgeClass: 'badge-pending',
				icon: 'fa-clock'
			},
			{
				keywords: ['#n/a', '', '-'],
				label: 'TIDAK VALID',
				badgeClass: 'badge-invalid',
				icon: 'fa-times-circle'
			}
		];

		const normalizeValidasi = (value) => {
			return cleanStr(value)
				.toLowerCase()
				.replace(/\s+/g, ' ')
				.trim();
		};


		const resolveValidasiStatus = (value) => {
			const val = normalizeValidasi(value);

			for (const status of VALIDASI_STATUS) {
				if (status.keywords.some(k => val.includes(k))) {
					return status;
				}
			}

			return VALIDASI_STATUS.find(s => s.label === 'TIDAK VALID');
		};


        
        // Fungsi untuk menentukan warna badge validasi
		const getValidasiBadge = (validasi) => {
			const status = resolveValidasiStatus(validasi);

			return `
				<span class="badge-validasi ${status.badgeClass}">
					<i class="fas ${status.icon} me-1"></i>${status.label}
				</span>
			`;
		};



		// Fungsi untuk mendapatkan kelas background berdasarkan persentase
		const getBackgroundClass = (percent) => {
			if (percent >= 100) return 'bg-complete';
			if (percent >= 90) return 'bg-high';
			if (percent >= 70) return 'bg-medium';
			return 'bg-low';
		};

        // Fungsi untuk mendapatkan kelas warna berdasarkan persentase
        const getPercentClass = (percent) => {
            if (percent >= 100) return 'percent-complete';
            if (percent >= 90) return 'percent-high';
            if (percent >= 70) return 'percent-medium';
            return 'percent-low';
        };

        // Fungsi untuk mendapatkan warna berdasarkan persentase
        const getColorForPercent = (percent) => {
            if (percent >= 100) return '#035c41'; // Hijau gelap
            if (percent >= 90) return '#10b981';  // Hijau
            if (percent >= 70) return '#f59e0b';  // Kuning/orange
            return '#ef4444';                     // Merah
        };

        // Fungsi untuk mendapatkan warna progress bar
        const getProgressColor = (percent) => {
            return getColorForPercent(percent);
        };


        // ================= DATA FETCHING =================
		function fetchData() {
			return new Promise((resolve, reject) => {
				const script = document.createElement('script');

				window.google = window.google || {};
				window.google.visualization = window.google.visualization || {};
				window.google.visualization.Query = window.google.visualization.Query || {};

				window.google.visualization.Query.setResponse = function (res) {
					document.head.removeChild(script);

					if (res.status === 'ok') {
						resolve(res.table);
					} else {
						reject(res.errors || 'Gagal mengambil data');
					}
				};

				script.src = `${GVIZ_URL}&tq=${encodeURIComponent(QUERY)}&cb=google.visualization.Query.setResponse`;
				script.onerror = () => reject('Network Error / Blocked');

				document.head.appendChild(script);
			});
		}

		// ================= SPLASH ANIMATION =================
		animateSplashProgress();

		function animateSplashProgress() {
			const bar = document.getElementById('splashBar');
			let progress = 0;

			const interval = setInterval(() => {
				if (progress < 85) {
					progress += Math.random() * 8;
					bar.style.width = progress + '%';
				}
			}, 200);

			window.finishSplash = function () {
				clearInterval(interval);
				bar.style.width = '100%';
			};
		}

		function hideSplashScreen() {
			const splash = document.getElementById('splashScreen');
			splash.classList.add('hidden');

			setTimeout(() => {
				splash.remove();
			}, 700);
		}

        // ================= PROCESS & RENDER =================
        async function initDashboard() {
            try {
                // Fetch data
                const rawTable = await fetchData();
				allData = rawTable.rows
					.map(r => {
						if (!r.c || r.c.length < 6) return null;

						const c = r.c;

						const statusVal = cleanStr(c[4]?.v);
						const validasiVal = cleanStr(c[5]?.v);

						return {
							nsm: cleanStr(c[0]?.v),
							nama: cleanStr(c[1]?.v),
							alamat: cleanStr(c[2]?.v),
							jml: safeInt(c[3]?.v),
							statusRaw: statusVal,
							validasi: validasiVal,
							jenjang: getJenjang(c[0]?.v),
							sukses: isSukses(statusVal)
						};
					})
					.filter(Boolean);

                if(allData.length === 0) throw new Error("Data Kosong");

                // Calculate statistics
                const stats = calculateStats(allData);
				const validasiStats = calculateValidasiStats(allData);
                const kecamatanStats = calculateKecamatanStats(allData);
                
                // Render all components
                renderCards(stats.perJenjang);
                renderOverallChart(stats.sukses, stats.belum);
				renderValidasiChart(validasiStats);
                renderKecamatanTable(kecamatanStats);
                initTable(allData);
                
                // Update table info
                document.getElementById('tableInfo').textContent = 
                    `Menampilkan ${allData.length} madrasah`;
                document.getElementById('totalKecamatanText').textContent = 
                    `Total: ${kecamatanStats.length} Kecamatan`;
				
				// Progress selesai 100%
				document.getElementById('splashBar').style.width = '100%';

				// Selesaikan progress
				if (window.finishSplash) window.finishSplash();

				// Tutup splash
				setTimeout(() => {
					hideSplashScreen();
				}, 300);

            } catch (err) {
                console.error(err);
                document.getElementById('loadingOverlay').innerHTML = `
                    <div class="text-center p-4 bg-white rounded shadow" style="max-width: 500px;">
                        <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                        <h5 class="fw-bold text-dark mb-2">Gagal Memuat Data</h5>
                        <p class="text-muted mb-3">${err.message || err}</p>
                        <button onclick="location.reload()" class="btn btn-primary">
                            <i class="fas fa-redo me-2"></i>Coba Lagi
                        </button>
                    </div>
                `;
            }
        }

        function calculateStats(data) {
            const stats = {
                total: data.length,
                sukses: data.filter(r => r.sukses).length,
                belum: data.filter(r => !r.sukses).length,
                perJenjang: {}
            };
            
            const jenjangList = ['RA', 'MI', 'MTS', 'MA', 'LAINNYA'];
            jenjangList.forEach(j => {
                const subset = data.filter(r => r.jenjang === j);
                stats.perJenjang[j] = {
                    total: subset.length,
                    sukses: subset.filter(r => r.sukses).length,
                    belum: subset.filter(r => !r.sukses).length,
                    name: j
                };
            });
            
            return stats;
        }

		function calculateKecamatanStats(data) {
			const kecamatanMap = {};
			
			// Group data by kecamatan
			data.forEach(item => {
				const kecamatan = item.alamat || 'Tidak Diketahui';
				if (!kecamatanMap[kecamatan]) {
					kecamatanMap[kecamatan] = {
						name: kecamatan,
						total: 0,
						sukses: 0,
						belum: 0
					};
				}
				
				kecamatanMap[kecamatan].total++;
				if (item.sukses) {
					kecamatanMap[kecamatan].sukses++;
				} else {
					kecamatanMap[kecamatan].belum++;
				}
			});
			
			// Convert to array and calculate percentages
			const kecamatanStats = Object.values(kecamatanMap).map(k => {
				const percent = k.total > 0 ? Math.round((k.sukses / k.total) * 100) : 0;
				return {
					...k,
					percent: percent,
					percentClass: getPercentClass(percent),
					progressColor: getProgressColor(percent),
					nameColor: getColorForPercent(percent),
					isComplete: percent === 100 // Tambahkan flag untuk kecamatan yang 100%
				};
			});
			
			// SORTING: Kecamatan 100% di atas, lalu diurutkan berdasarkan nama A-Z
			kecamatanStats.sort((a, b) => {
				// Prioritaskan yang 100%
				if (a.isComplete && !b.isComplete) return -1;
				if (!a.isComplete && b.isComplete) return 1;
				
				// Jika sama-sama 100% atau sama-sama belum 100%, urutkan berdasarkan nama A-Z
				return a.name.localeCompare(b.name);
			});
			
			return kecamatanStats;
		}

		function renderKecamatanTable(kecamatanStats) {
			const container = document.getElementById('kecamatanGrid');
			container.innerHTML = '';
			
			// Hitung jumlah kecamatan yang sudah 100%
			const completeCount = kecamatanStats.filter(k => k.isComplete).length;
			
			const completeBadge = document.getElementById('completeBadge');
			if (completeBadge) {
				if (completeCount > 0) {
					completeBadge.textContent = `${completeCount} Kecamatan 100%`;
					completeBadge.classList.remove('d-none');
				} else {
					completeBadge.classList.add('d-none');
				}
			}
			// Update teks header
			const headerText = document.querySelector('#kecamatanTableContainer .chart-header .small');
			if (headerText && headerText.querySelector('#totalKecamatanText')) {
				headerText.querySelector('#totalKecamatanText').textContent = 
					`Total: ${kecamatanStats.length} Kecamatan (${completeCount} sudah 100%)`;
			}
			
			kecamatanStats.forEach(kec => {
				const item = document.createElement('div');
				
				const percent = kec.percent || Math.round((kec.sukses / kec.total) * 100);
				const percentClass = kec.percentClass || getPercentClass(percent);
				const backgroundClass = kec.isComplete ? 'bg-complete' : getBackgroundClass(percent);
				const progressColor = kec.progressColor || getProgressColor(percent);
				const nameColor = kec.nameColor || getColorForPercent(percent);
				
				// Tambahkan icon untuk kecamatan yang sudah 100%
				const completeIcon = kec.isComplete ? 
					'<i class="fas fa-check-circle me-1" style="font-size: 0.7rem;"></i>' : '';
				
				item.className = `kecamatan-item ${backgroundClass}`;
				
				item.innerHTML = `
					<div class="kecamatan-row">
						<div class="kecamatan-left">
							<div class="kecamatan-name" style="color: ${nameColor}">
								${completeIcon}${kec.name}
							</div>
							<div class="kecamatan-count">
								${kec.sukses} dari ${kec.total}
							</div>
						</div>
						<div class="kecamatan-right">
							<div class="kecamatan-percent ${percentClass}">
								${percent}%
							</div>
						</div>
					</div>
					<div class="kecamatan-progress-container">
						<div class="kecamatan-progress-bar" 
							 style="width: ${Math.min(percent, 100)}%; background-color: ${progressColor};">
						</div>
					</div>
				`;
				
				container.appendChild(item);
			});
			
			setTimeout(() => {
				const containerElement = document.querySelector('.kecamatan-table-container');
				if (containerElement) {
					containerElement.scrollTop = 0;
				}
			}, 100);
		}
        function renderCards(data) {
            const container = document.getElementById('statsCards');
            const config = {
                'RA': { icon: 'fa-shapes', color: 'bg-icon-ra', bar: 'bg-danger' },
                'MI': { icon: 'fa-child-reaching', color: 'bg-icon-mi', bar: 'bg-primary' },
                'MTS': { icon: 'fa-book-open', color: 'bg-icon-mts', bar: 'bg-success' },
                'MA': { icon: 'fa-graduation-cap', color: 'bg-icon-ma', bar: 'bg-warning' },
                'LAINNYA': { icon: 'fa-school', color: 'bg-light', bar: 'bg-secondary' }
            };

            container.innerHTML = '';
            
            Object.keys(data).forEach(key => {
                const s = data[key];
                if (s.total === 0) return;
                
                const pct = s.total > 0 ? Math.round((s.sukses / s.total) * 100) : 0;
                const conf = config[key] || { icon: 'fa-school', color: 'bg-light', bar: 'bg-secondary' };

                const html = `
                <div class="col-md-6 col-lg-3">
                    <div class="custom-card p-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="stat-icon ${conf.color}">
                                    <i class="fas ${conf.icon}"></i>
                                </div>
                                <h5 class="fw-bold mb-1">${key}</h5>
                                <div class="text-muted small">${s.total} Lembaga</div>
                            </div>
                            <div class="text-end">
                                <div class="display-6 fw-bold text-dark">${pct}%</div>
                                <span class="badge ${pct === 100 ? 'bg-success' : 'bg-light text-dark'} rounded-pill border">
                                    ${s.sukses} Selesai
                                </span>
                            </div>
                        </div>
                        <div class="mt-3 small">
                            <div class="d-flex justify-content-between text-muted">
                                <span>Sudah: ${s.sukses}</span>
                                <span>Belum: ${s.belum}</span>
                            </div>
                        </div>
                        <div class="progress progress-micro mt-2">
                            <div class="progress-bar ${conf.bar} progress-bar-animated" 
                                 role="progressbar" 
                                 style="width: ${pct}%"></div>
                        </div>
                    </div>
                </div>`;
                container.insertAdjacentHTML('beforeend', html);
            });
        }

		function renderOverallChart(sukses, belum) {
			const ctx = document.getElementById('overallChart');
			const total = sukses + belum;
			const pct = Math.round((sukses / total) * 100);

			// Update text dengan animasi
			animateValue('totalPercent', 0, pct, 1500);

			// Destroy existing chart
			if (overallChart) overallChart.destroy();

			// Data awal untuk animasi (0, total)
			const initialData = [0, total];
			const finalData = [sukses, belum];

			overallChart = new Chart(ctx, {
				type: 'doughnut',
				data: {
					labels: ['Sudah Tarik', 'Belum Tarik'],
					datasets: [{
						data: initialData, // Mulai dari 0
						backgroundColor: ['#10b981', '#ef4444'],
						borderWidth: 0,
						hoverOffset: 10,
						borderRadius: 8
					}]
				},
				options: {
					responsive: true,
					maintainAspectRatio: false,
					cutout: '70%',
					layout: {
						padding: {
							top: 10,
							bottom: 20,
							left: 10,
							right: 10
						}
					},
					plugins: {
						legend: { 
							position: 'bottom',
							align: 'center',
							labels: { 
								usePointStyle: true,
								padding: 20,
								font: { 
									family: "'Plus Jakarta Sans', sans-serif", 
									size: 12 
								},
								boxWidth: 10,
								boxHeight: 10
							}
						},
						tooltip: {
							callbacks: {
								label: function(context) {
									const value = context.raw;
									const percentage = Math.round((value / total) * 100);
									return ` ${context.label}: ${value} (${percentage}%)`;
								}
							}
						}
					},
					// Animasi chart
					animation: {
						duration: 1500,
						easing: 'easeOutQuart'
					}
				}
			});

			// Animasi chart dari 0 ke nilai sebenarnya
			setTimeout(() => {
				overallChart.data.datasets[0].data = finalData;
				overallChart.update();
			}, 100);
		}

		function renderValidasiChart(stats) {
			const ctx = document.getElementById('validasiChart');

			const total = stats.SUDAH + stats.BELUM + stats.PROSES + stats.TIDAK_VALID;

			const pct = total > 0 
				? Math.round((stats.SUDAH / total) * 100) 
				: 0;

			animateValue('validasiPercent', 0, pct, 1500);

			if (validasiChart) validasiChart.destroy();

			validasiChart = new Chart(ctx, {
				type: 'doughnut',
				data: {
					labels: [
						'Sudah',
						'Belum',
						'Proses',
						'Tidak Valid'
					],
					datasets: [{
						data: [
							stats.SUDAH,
							stats.BELUM,
							stats.PROSES,
							stats.TIDAK_VALID
						],
						backgroundColor: [
							'#10b981',  // hijau
							'#ef4444',  // merah
							'#f59e0b',  // kuning
							'#6b7280'   // abu
						],
						borderWidth: 0,
						hoverOffset: 10,
						borderRadius: 8
					}]
				},
				options: {
					responsive: true,
					maintainAspectRatio: false,
					cutout: '70%',
					layout: {
						padding: {
							top: 10,
							bottom: 20,
							left: 10,
							right: 10
						}
					},
					plugins: {
						legend: { 
							position: 'bottom',
							align: 'center',
							labels: { 
								usePointStyle: true,
								padding: 20,
								font: { 
									family: "'Plus Jakarta Sans', sans-serif", 
									size: 12 
								},
								boxWidth: 10,
								boxHeight: 10
							}
						},
					},
					animation: {
						duration: 1500,
						easing: 'easeOutQuart'
					}
				}
			});
		}


		// Fungsi helper untuk animasi angka
		function animateValue(elementId, start, end, duration) {
			const element = document.getElementById(elementId);
			if (!element) return;
			
			let startTimestamp = null;
			const step = (timestamp) => {
				if (!startTimestamp) startTimestamp = timestamp;
				const progress = Math.min((timestamp - startTimestamp) / duration, 1);
				const currentValue = Math.floor(progress * (end - start) + start);
				element.textContent = currentValue + '%';
				
				if (progress < 1) {
					window.requestAnimationFrame(step);
				}
			};
			window.requestAnimationFrame(step);
		}
		
		function calculateValidasiStats(data) {
			const stats = {
				SUDAH: 0,
				BELUM: 0,
				PROSES: 0,
				TIDAK_VALID: 0
			};

			data.forEach(d => {
				const status = resolveValidasiStatus(d.validasi);

				switch (status.label) {
					case 'SUDAH VALIDASI':
						stats.SUDAH++;
						break;
					case 'BELUM VALIDASI':
						stats.BELUM++;
						break;
					case 'PROSES':
						stats.PROSES++;
						break;
					default:
						stats.TIDAK_VALID++;
				}
			});

			return stats;
		}

		function initTable(data) {
            const tbody = document.querySelector('#madrasahTable tbody');
            
            // Populate Dropdown Jenjang
            const jenjangSet = new Set(data.map(d => d.jenjang));
            const selectJenjang = document.getElementById('filterJenjang');
            jenjangSet.forEach(j => {
                if (j) {
                    selectJenjang.insertAdjacentHTML('beforeend', `<option value="${j}">${j}</option>`);
                }
            });

			// Populate Dropdown Alamat (Diurutkan A-Z)
			const alamatList = Array.from(new Set(data.map(d => d.alamat).filter(a => a)));
			alamatList.sort(); // Urutkan dari A-Z
			const selectAlamat = document.getElementById('filterAlamat');
			alamatList.forEach(a => {
				if (a) {
					selectAlamat.insertAdjacentHTML('beforeend', `<option value="${a}">${a}</option>`);
				}
			});

            // Populate DOM dengan struktur baru
            const rowsHtml = data.map(r => `
                <tr>
                    <td class="fw-bold text-secondary font-monospace">${r.nsm}</td>
                    <td>${r.nama}</td>
                    <td>${r.alamat || '-'}</td>
                    <td class="text-end">${r.jml.toLocaleString('id-ID')}</td>
                    <td>
                        <span class="${r.sukses ? 'text-status-sukses' : 'text-status-belum'}">
                            ${r.statusRaw || '-'}
                        </span>
                    </td>
                    <td>${getValidasiBadge(r.validasi)}</td>
                </tr>
            `).join('');
            tbody.innerHTML = rowsHtml;

            // Initialize DataTables dengan responsive settings
            if (dataTable) {
                dataTable.destroy();
            }

            dataTable = $('#madrasahTable').DataTable({
                responsive: true,
                autoWidth: false,
                pageLength: 10,
                lengthMenu: [[10, 25, 50, -1], ["10", "25", "50", "Semua"]],
				dom: '<"dt-grid-container"<"dt-grid-item-left"l><"dt-grid-item-center"f><"dt-grid-item-right"B>>rt<"dt-grid-bottom"ip>',
				buttons: [
                    { 
                        extend: 'excelHtml5', 
                        className: 'btn btn-dt-excel mb-2 mb-md-0', 
                        text: '<i class="fas fa-file-excel me-1"></i> Excel',
                        title: 'Data_Madrasah_Sumenep'
                    },
                    { 
                        extend: 'pdfHtml5', 
                        className: 'btn btn-dt-pdf mb-2 mb-md-0', 
                        text: '<i class="fas fa-file-pdf me-1"></i> PDF',
                        title: 'Data_Madrasah_Sumenep'
                    },
                    { 
                        extend: 'print', 
                        className: 'btn btn-dt-print mb-2 mb-md-0', 
                        text: '<i class="fas fa-print me-1"></i> Print',
                        title: 'Data Madrasah Sumenep'
                    }
                ],
				language: {
					search: "_INPUT_",
					searchPlaceholder: "Cari NSM / Nama...",
					paginate: { 
						next: '<i class="fas fa-chevron-right"></i>', 
						previous: '<i class="fas fa-chevron-left"></i>' 
					},
					info: "Menampilkan _START_ - _END_ dari _TOTAL_ data",
					lengthMenu: "Tampilkan _MENU_ data"
				},
                columnDefs: [
                    { 
                        targets: [0, 3, 4, 5], // NSM, Jml Siswa, Status, Validasi - rata tengah
                        className: "text-center align-middle"
                    },
                    { 
                        targets: [1, 2], // Nama Madrasah dan Alamat - rata kiri
                        className: "align-middle"
                    },
                    { responsivePriority: 1, targets: 1 }, // Nama Madrasah
                    { responsivePriority: 2, targets: 2 }, // Alamat
                    { responsivePriority: 3, targets: 4 }, // Status
                    { responsivePriority: 4, targets: 5 }, // Validasi
                    { responsivePriority: 5, targets: 0 }, // NSM
                    { responsivePriority: 6, targets: 3 }, // Jml Siswa
                    { className: "text-nowrap", targets: [0, 3, 4, 5] }
                ]
            });

            // Custom Filtering Logic
            $.fn.dataTable.ext.search.push((settings, data, dataIndex) => {
                const fJenjang = $('#filterJenjang').val();
                const fAlamat = $('#filterAlamat').val();
                const fStatus = $('#filterStatus').val();
				const fValidasi = $('#filterValidasi').val();

                // Get the row node
                const rowNode = dataTable.row(dataIndex).node();
                if (!rowNode) return true;
                
                // Extract data from row
                const rowNSM = $(rowNode).find('td:first-child').text().trim();
                const rowJenjang = getJenjang(rowNSM);
                const rowAlamat = $(rowNode).find('td:nth-child(3)').text().trim();
                const isSuksesRow = $(rowNode).find('.text-status-sukses').length > 0;
                const statusCheck = isSuksesRow ? 'SUKSES' : 'BELUM';

                if (fJenjang && rowJenjang !== fJenjang) return false;
                if (fAlamat && rowAlamat !== fAlamat) return false;
                if (fStatus && statusCheck !== fStatus) return false;
				if (fValidasi) {
					const validasiCell = $(rowNode).find('td:nth-child(6)').text().trim();
					if (validasiCell !== fValidasi) return false;
				}
                return true;
            });

            // Event Listeners
            $('#filterJenjang, #filterAlamat, #filterStatus, #filterValidasi').on('change', function() {
                dataTable.draw();
                updateTableInfo();
            });

            $('#resetFilters').on('click', function() {
                $('#filterJenjang').val('');
                $('#filterAlamat').val('');
                $('#filterStatus').val('');
				$('#filterValidasi').val('');
                dataTable.search('').draw();
                updateTableInfo();
            });

            // Update table info on page change
            dataTable.on('draw', updateTableInfo);

            function updateTableInfo() {
                const filteredCount = dataTable.rows({ search: 'applied' }).count();
                document.getElementById('tableInfo').textContent = 
                    `Menampilkan ${filteredCount} dari ${allData.length} madrasah`;
            }
        }

        // Handle window resize for charts
        let resizeTimer;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(function() {
                if (overallChart) overallChart.resize();
                if (validasiChart) validasiChart.resize();
            }, 250);
        });

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', initDashboard);

    </script>
</body>
</html>
